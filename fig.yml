db:
  image: mysql:5.7
  ports:
    - "3306:3306"
  volumes:
    - "./data/mysql:/var/lib/mysql"
  environment:
    MYSQL_USER: sharetribe
    MYSQL_PASSWORD: secret
    MYSQL_DATABASE: sharetribe_production
    MYSQL_ROOT_PASSWORD: secret

redis:
  image: redis:latest
  ports:
    - "6379:6379"
  volumes:
    - "./data/redis:/data"

worker:
  build: .
  command: '/bin/bash -l -c "bundle exec rake jobs:work"'
  links:
    - db:mysql
    - redis:redis
  volumes:
    - .:/opt/sharetribe
    - ./data/sharetribe/public/system/images:/opt/app/public/system/images
  environment:
    QUEUES: default,paperclip,mailers
    MAGICK_MAP_LIMIT: 64MiB
    MAGICK_MEMORY_LIMIT: 256MiB
    MAGICK_TIME_LIMIT: 30
    redis_host: redis

search:
  build: .
  command: '/bin/bash -l -c "bundle exec rake ts:configure ts:index; searchd --nodetach --pidfile --config config/production.sphinx.conf"'
  links:
    - db:mysql
    - redis:redis
  volumes:
    - .:/opt/sharetribe
    - ./data/sphinx:/opt/app/db/sphinx
  ports:
    - "3563:3563"
  environment:
    SPHINX_HOST: ""
    redis_host: redis

web:
  build: .
  command: '/bin/bash -l -c "bundle exec rails server"'
  volumes:
     - .:/opt/sharetribe
     - ./data/sharetribe/public/system/images:/opt/app/public/system/images
  ports:
    - "3000:3000"
  links:
    - db:mysql
    - search:search
    - worker:worker
    - redis:redis
  environment:
    SPHINX_HOST: search
    redis_host: redis

